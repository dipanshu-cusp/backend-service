name: CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    

permissions:
  actions: write
  contents: read
  pull-requests: read

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: pip install poetry

      - name: Configure Git for private GitHub dependencies
        env:
          GITHUB_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [ -z "$GITHUB_PAT" ]; then
            echo "GITHUB_PAT secret is required for private dependencies."
            exit 1
          fi
          export GIT_TERMINAL_PROMPT=0
          git config --global url."https://x-access-token:${GITHUB_PAT}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${GITHUB_PAT}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${GITHUB_PAT}@github.com/".insteadOf "git+ssh://git@github.com/"

      - name: Validate token can read shared-package
        env:
          GITHUB_PAT: ${{ secrets.GH_PAT }}
        run: |
          git ls-remote https://x-access-token:${GITHUB_PAT}@github.com/dipanshu-cusp/shared-package.git HEAD

      - name: Install dependencies
        env:
          POETRY_SYSTEM_GIT_CLIENT: "true"
        run: |
          poetry config system-git-client true || poetry config experimental.system-git-client true || true
          poetry install --no-interaction --no-ansi -v

      - name: Install lint/type tools
        run: poetry run python -m pip install ruff mypy

      - name: Run linter
        run: poetry run ruff check src

      - name: Run type checks
        run: poetry run mypy src --ignore-missing-imports
